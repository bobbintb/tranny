//@ sourceMappingURL=tranny-torrents.map
// Generated by CoffeeScript 1.6.1

/* Contains a list of currently selected DT_RowId (info_hash's)
*/


(function() {
  var action_start, action_stop, row_load_cb, row_select_cb, selected_class, selected_rows;

  selected_rows = [];

  selected_class = 'selected';

  /*
      Called for each new row loaded into the data table
  
      @param {string} DT_RowId defined for the row ( which corresponds to the info_hash )
      @param {object} The rows data object
      @param {number} Index of the row in the table
  */


  row_load_cb = function(row, data, displayIndex) {
    if (jQuery.inArray(data.DT_RowId, selected_rows) !== -1) {
      return jQuery(row).addClass(selected_class);
    }
  };

  /*
      Called when a user selects a row with the cursor. Will update the currently selected rows.
      If the user holds ctrl while clicking the row will be added to the selected_rows array. Otherwise
      the row will be "activated" and show more detailed information for that row in another panel.
  */


  row_select_cb = function(e) {
    var existing_row_id, index, row_id, _i, _len;
    row_id = this.id;
    if (e.ctrlKey) {
      index = _.indexOf(selected_rows, row_id);
      if (index === -1) {
        selected_rows.push(row_id);
      } else {
        selected_rows.splice(index, 1);
      }
      jQuery(this).toggleClass(selected_class);
      return console.log("Selected " + selected_rows.length + " rows!");
    } else {
      for (_i = 0, _len = selected_rows.length; _i < _len; _i++) {
        existing_row_id = selected_rows[_i];
        jQuery("#" + existing_row_id).removeClass(selected_class);
      }
      selected_rows = [row_id];
      jQuery("#" + row_id).addClass(selected_class);
      return console.log("Selected single row!");
    }
  };

  action_stop = function() {
    return jQuery.ajax('/torrents/stop', {
      data: JSON.stringify(selected_rows),
      contentType: 'application/json',
      type: 'POST'
    });
  };

  action_start = function() {
    return jQuery.ajax('/torrents/start', {
      data: JSON.stringify(selected_rows),
      contentType: 'application/json',
      type: 'POST'
    });
  };

  jQuery(function() {
    jQuery('#torrent_table').dataTable({
      processing: true,
      serverSize: true,
      ajax: "/torrents/list",
      paginate: false,
      scrollY: 300,
      columns: [
        {
          data: 'name'
        }, {
          data: 'ratio'
        }, {
          data: 'up_rate'
        }, {
          data: 'dn_rate'
        }, {
          data: 'leechers'
        }, {
          data: 'peers'
        }, {
          data: 'priority'
        }, {
          data: 'is_active'
        }
      ],
      rowCallback: row_load_cb
    });
    jQuery('#torrent_table tbody').on('click', 'tr', row_select_cb);
    jQuery('#action_stop').on('click', action_stop);
    return jQuery('#action_start').on('click', action_start);
  });

}).call(this);
